name: cloudflared-snap
base: core18
version: "0.1"
summary: cloudflared for snap
description: |
  enables you to use argo tunnel in snap based devices

grade: stable
confinement: strict
architectures:
  - build-on: arm64
  - build-on: amd64
parts:
  cloudflared:
    plugin: go
    source: https://github.com/cloudflare/cloudflared.git
    go-importpath: github.com/cloudflare/cloudflared/cmd/cloudflared
    build-packages:
      - build-essential
    stage-packages: [libstdc++6]
    override-build: |
      make cloudflared
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp cloudflared $SNAPCRAFT_PART_INSTALL/bin
      snapcraftctl build
plugs:
  config-cloudflared:
    interface: personal-files
    read:
      - $HOME/.cloudflared/cert.pem
      - $HOME/.cloudflared/config.yml
apps:
  cloudflared:
    command: cloudflared
    adapter: none
    plugs:
      - network
      - network-bind
      - config-cloudflared
  login:
    command: cloudflared tunnel login
    plugs:
      - network
      - network-bind
      - config-cloudflared
  tunnel:
    command: cloudflared tunnel --config $HOME/.cloudflared/config.yml --origincert $HOME/.cloudflared/cert.pem --no-autoupdate
    daemon: simple
    passthrough:
      watchdog-timeout: 10s
    plugs:
      - network
      - network-bind
      - daemon-notify
      - config-cloudflared
